name: CI/CD Pipeline

on:
  push:
    branches:
      - develop
      - main
  pull_request:
    branches:
      - develop
      - main

env:
  NODE_VERSION: '18'
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

jobs:
  # ğŸ” AnÃ¡lisis de CÃ³digo y Calidad
  code-quality:
    name: ğŸ” Code Quality & Security
    runs-on: ubuntu-latest
    
    steps:
      # 1ï¸âƒ£ Clonar el cÃ³digo
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Necesario para anÃ¡lisis de cÃ³digo

      # 2ï¸âƒ£ Configurar Node.js
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      # 3ï¸âƒ£ Instalar dependencias
      - name: ğŸ“š Install dependencies
        run: npm ci

      # 4ï¸âƒ£ Verificar tipos de TypeScript (solo cÃ³digo principal, excluyendo docs)
      - name: ğŸ” TypeScript type check
        run: npm run type-check:pipeline

      # 5ï¸âƒ£ Linting con ESLint
      - name: ğŸ§¹ Run ESLint
        run: npm run lint

      # 6ï¸âƒ£ AuditorÃ­a de seguridad de dependencias
      - name: ğŸ”’ Security audit
        run: npm audit --audit-level=high
        continue-on-error: true # No fallar el build por vulnerabilidades menores

      # 7ï¸âƒ£ Verificar que el build funciona
      - name: ğŸ—ï¸ Build check
        run: npm run build
        env:
          # Variables de entorno para el build (sin valores reales)
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}

  # ğŸ§ª Testing
  test:
    name: ğŸ§ª Unit Tests
    runs-on: ubuntu-latest
    needs: code-quality # Solo ejecutar si code-quality pasa
    
    steps:
      # 1ï¸âƒ£ Clonar el cÃ³digo
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Configurar Node.js
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      # 3ï¸âƒ£ Instalar dependencias
      - name: ğŸ“š Install dependencies
        run: npm ci

      # 4ï¸âƒ£ Ejecutar pruebas unitarias
      - name: ğŸ§ª Run unit tests
        run: npm run test:ci
        env:
          # Variables de entorno para tests
          NODE_ENV: test

      # 5ï¸âƒ£ Subir cobertura de cÃ³digo
      - name: ğŸ“Š Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
        continue-on-error: true

  # ğŸ“š DocumentaciÃ³n
  docs:
    name: ğŸ“š Build Documentation
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
      # 1ï¸âƒ£ Clonar el cÃ³digo
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Configurar Node.js
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      # 3ï¸âƒ£ Instalar dependencias del proyecto
      - name: ğŸ“š Install project dependencies
        run: npm ci

      # 4ï¸âƒ£ Instalar dependencias de documentaciÃ³n
      - name: ğŸ“š Install docs dependencies
        run: cd docs && npm ci

      # 5ï¸âƒ£ Build de documentaciÃ³n
      - name: ğŸ“š Build documentation
        run: npm run docs:build

      # 6ï¸âƒ£ Verificar que la documentaciÃ³n se construyÃ³ correctamente
      - name: âœ… Verify docs build
        run: |
          if [ ! -d "docs/build" ]; then
            echo "Documentation build failed"
            exit 1
          fi
          echo "Documentation built successfully"

  # ğŸš€ Deploy a Vercel (solo en develop y main)
  deploy:
    name: ğŸš€ Deploy to Vercel
    runs-on: ubuntu-latest
    needs: [code-quality, test, docs] # Solo deploy si todos los jobs anteriores pasan
    if: github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/main'
    
    steps:
      # 1ï¸âƒ£ Clonar el cÃ³digo
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Configurar Node.js
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      # 3ï¸âƒ£ Instalar dependencias
      - name: ğŸ“š Install dependencies
        run: npm ci

      # 4ï¸âƒ£ Instalar Vercel CLI
      - name: ğŸ“¦ Install Vercel CLI
        run: npm install --global vercel@latest

      # 5ï¸âƒ£ Pull informaciÃ³n del proyecto Vercel
      - name: ğŸ”— Pull Vercel Environment Information
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}

      # 6ï¸âƒ£ Build del proyecto
      - name: ğŸ—ï¸ Build Project Artifacts
        run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}

      # 7ï¸âƒ£ Deploy a Vercel
      - name: ğŸš€ Deploy Project Artifacts to Vercel
        id: deploy
        run: |
          url=$(vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }})
          echo "deployment-url=$url" >> $GITHUB_OUTPUT
          echo "ğŸš€ Deployment URL: $url"

      # 8ï¸âƒ£ Comentar en PR con el link de deploy (solo para PRs)
      - name: ğŸ’¬ Comment PR with deployment URL
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ğŸš€ **Deployment Preview**\n\nâœ… Build successful!\nğŸ”— Preview URL: ${{ steps.deploy.outputs.deployment-url }}\n\n---\n\n*Deployment generado automÃ¡ticamente por GitHub Actions*`
            })

  # ğŸ“Š Reporte de Status
  status:
    name: ğŸ“Š Pipeline Status
    runs-on: ubuntu-latest
    needs: [code-quality, test, docs, deploy]
    if: always() # Siempre ejecutar para reportar status
    
    steps:
      # 1ï¸âƒ£ Reportar status del pipeline
      - name: ğŸ“Š Report pipeline status
        run: |
          if [[ "${{ needs.code-quality.result }}" == "success" && 
                "${{ needs.test.result }}" == "success" && 
                "${{ needs.docs.result }}" == "success" ]]; then
            echo "âœ… All checks passed!"
            echo "ğŸš€ Pipeline completed successfully"
          else
            echo "âŒ Some checks failed:"
            echo "  - Code Quality: ${{ needs.code-quality.result }}"
            echo "  - Tests: ${{ needs.test.result }}"
            echo "  - Docs: ${{ needs.docs.result }}"
            echo "  - Deploy: ${{ needs.deploy.result }}"
            exit 1
          fi
